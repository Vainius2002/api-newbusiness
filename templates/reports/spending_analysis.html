{% extends "base.html" %}

{% block title %}Spending Analysis - Media Agency Lead Management{% endblock %}

{% block content %}
<h1 class="mb-4">Spending Analysis</h1>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Spending by Media Channel</h5>
            </div>
            <div class="card-body">
                <div id="channelChart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    {% for channel, data in channel_data.items() %}
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Top {{ channel.replace('_', ' ').title() }} Spenders</h6>
            </div>
            <div class="card-body">
                {% if data %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Advertiser</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for advertiser in data %}
                            <tr>
                                <td>{{ advertiser[0] }}</td>
                                <td class="text-end">â‚¬{{ "{:,.0f}".format(advertiser[1]) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No spending data for this channel</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Export Options</h5>
            </div>
            <div class="card-body">
                {% if current_user.is_team_lead() %}
                <a href="{{ url_for('reports.export_data') }}?type=advertisers&format=csv" class="btn btn-primary me-2">
                    <i class="bi bi-download"></i> Export Advertisers (CSV)
                </a>
                <a href="{{ url_for('reports.export_data') }}?type=advertisers&format=xlsx" class="btn btn-success me-2">
                    <i class="bi bi-download"></i> Export Advertisers (Excel)
                </a>
                <a href="{{ url_for('reports.export_data') }}?type=activities&format=csv" class="btn btn-info me-2">
                    <i class="bi bi-download"></i> Export Activities (CSV)
                </a>
                {% else %}
                <p class="text-muted">Export functionality is available for team leads and administrators only.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Render channel comparison chart
    var channelData = {{ channel_json | safe }};
    Plotly.newPlot('channelChart', channelData.data, channelData.layout, {responsive: true});
</script>
{% endblock %}